<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Voice Agent Demo</title>
    <style>
      body { font-family: sans-serif; }
      #logs { white-space: pre; border: 1px solid #ccc; width: 400px; height: 300px; overflow-y: auto; padding: 5px; }
      button { margin: 10px; }
    </style>
  </head>
  <body>
    <h1>Voice Agent with Function Calling</h1>
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <div id="logs"></div>

    <script>
      let mediaRecorder, ws;
      const logs = document.getElementById('logs');

      function log(text) {
        logs.textContent += text + "\n";
        logs.scrollTop = logs.scrollHeight;
      }

      document.getElementById('startBtn').onclick = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream /* no explicit mimeType */);

          ws = new WebSocket(`ws://${window.location.host}/stt`);
          ws.binaryType = 'arraybuffer';

          ws.onopen = () => log("WS connected to /stt");
          ws.onmessage = (evt) => {
            const msg = JSON.parse(evt.data);
            if (msg.is_final) {
              log("Final: " + msg.transcript);
            } else {
              log("Partial: " + msg.transcript);
            }
          };
          ws.onclose = () => log("WS closed");
          ws.onerror = (err) => log("WS error: " + err);

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
              e.data.arrayBuffer().then((buff) => {
                ws.send(buff);
              });
            }
          };

          mediaRecorder.start(300); // chunk every 300ms
          log("Recording started...");
        } catch (err) {
          log("Error: " + err);
        }
      };

      document.getElementById('stopBtn').onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          log("Recording stopped.");
        }
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
          log("WebSocket closed.");
        }
      };
    </script>
  </body>
</html>
