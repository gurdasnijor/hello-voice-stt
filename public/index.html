<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Deepgram + OpenAI LLM Demo</title>
</head>
<body>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>

  <h3>Transcripts (Partial / Final):</h3>
  <textarea id="transcriptLog" rows="10" cols="50" readonly></textarea>

  <h3>LLM Responses:</h3>
  <textarea id="agentOutput" rows="10" cols="50" readonly></textarea>

  <script>
    let mediaRecorder, ws;
    const transcriptBox = document.getElementById("transcriptLog");
    const agentBox = document.getElementById("agentOutput");

    function appendTranscript(text) {
      transcriptBox.value += text + "\n";
    }
    function appendLLMResponse(text) {
      agentBox.value += text + "\n";
    }

    document.getElementById("startBtn").onclick = async () => {
      try {
        // 1) request mic
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // 2) create mediaRecorder
        mediaRecorder = new MediaRecorder(stream);

        // 3) connect to /stt
        ws = new WebSocket(`ws://${window.location.host}/stt`);
        ws.onopen = () => appendTranscript("WS connected /stt");
        ws.onclose = () => appendTranscript("WS closed");

        // 4) handle incoming transcripts or LLM
        ws.onmessage = (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            // partial / final transcript
            if (msg.transcript) {
              if (msg.is_final) {
                appendTranscript("[Final] " + msg.transcript);
              } else {
                appendTranscript("[Partial] " + msg.transcript);
              }
            }
            // llmResponse
            if (msg.llmResponse) {
              appendLLMResponse("LLM says: " + msg.llmResponse);
            }
          } catch (err) {
            // if we get binary data or invalid JSON
            console.log("Got unparseable data from server:", evt.data);
          }
        };

        // 5) send mic chunks to server
        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0 && ws.readyState === WebSocket.OPEN) {
            e.data.arrayBuffer().then((buff) => {
              ws.send(buff);
            });
          }
        };

        // chunk every 300ms
        mediaRecorder.start(300);
        appendTranscript("Recording started...");
      } catch (err) {
        appendTranscript("Error: " + err);
      }
    };

    document.getElementById("stopBtn").onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        appendTranscript("Recording stopped.");
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
    };
  </script>
</body>
</html>
